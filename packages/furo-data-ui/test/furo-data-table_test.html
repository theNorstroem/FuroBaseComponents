<!doctype html>

<html>
<head>
    <title>test for furo-data-table</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">

    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">
    <script src="/node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
    <script src="/node_modules/mocha/mocha.js"></script>
    <script src="/node_modules/chai/chai.js"></script>
    <script src="/node_modules/@polymer/test-fixture/test-fixture.js"></script>
    <script src="/node_modules/wct-mocha/wct-mocha.js"></script>
    <script src="/node_modules/sinon/pkg/sinon.js"></script>

    <script type="module">
        import '../furo-catalog.js';
        import '@furo/framework';
        import '@furo/data';
        import "@furo/fbp/flow-bind";
    </script>
</head>
<body>

<test-fixture id="basic">
    <template>
        <flow-bind>
            <template>
                <deep-link service="tasks"
                           @-hts-out="--hts">
                </deep-link>

                <collection-agent service="tasks"
                                  ƒ-hts-in="--hts"
                                  list-on-hts-in
                                  @-response="--colResponded">
                </collection-agent>
                <collection-object type="vnd.com.acme.task" ƒ-inject-raw="--colResponded"
                                   @-object-ready="--data"></collection-object>
                <furo-data-table ƒ-bind-data="--data"></furo-data-table>
            </template>
        </flow-bind>

    </template>
</test-fixture>

<script type="module">

    let expect = chai.expect;

    import '/node_modules/axe-core/axe.min.js';
    import {axeReport} from '/node_modules/pwa-helpers/axe-report.js';

    import {Init} from "@furo/framework";
    import {Services, Types} from "./apiConfig.js"

    Init.registerApiServices(Services);
    Init.registerApiTypes(Types);

    function keydown(TargetElement, key) {
        let customEvent = new Event('keydown', {composed: true, bubbles: true});
        customEvent.code = key; // Deprecated, prefer .key instead.
        customEvent.key = key;
        TargetElement.dispatchEvent(customEvent);

    }

    describe('furo-data-table tests ', function () {

        let fix, linker, dataTable;

        beforeEach(async () => {
            fix = fixture('basic');


            dataTable = fix[4];
            dataTable.type = "vnd.com.acme.task";
            await dataTable.updateComplete;
            linker = fix[1];
            await linker.updateComplete;

        });

        it('should have the correct type information', (done) => {
            assert.equal(dataTable._type, "vnd.com.acme.task");
            assert.equal(dataTable.cols.length, 8);
            done()

        });

        it('should assign the correct meta information', (done) => {
            assert.equal(dataTable.cols[0].meta.datatable.row_width, "width-l");
            assert.equal(dataTable.cols[1].meta.datatable.row_width, "width-s");
            assert.equal(dataTable.cols[2].meta.datatable.row_width, "width-xl");

            assert.equal(dataTable.shadowRoot.querySelector('table').querySelector('tbody').querySelector('template').content.querySelector('tr').childElementCount, 10);
            done()
        });

        it('empty or invalid type should fire spec-error', (done) => {

            dataTable.addEventListener('spec-error', (e) => {

                assert.equal(e.detail, "vnd.com.acme.invalid");
                done();
            });
            dataTable.type = "vnd.com.acme.invalid";

        });

        it('should focus first row', (done) => {

            dataTable.addEventListener('data-loaded', () => {
                dataTable._collection.addEventListener('data-changed', () => {
                    dataTable.focus();
                    assert.equal(dataTable._selectedIndex, 0);

                    done();
                });
            });
            linker.trigger();
        });

        it('should select a specific row', (done) => {

            dataTable.addEventListener('data-loaded', () => {
                dataTable._collection.addEventListener('data-changed', () => {
                    dataTable.focus();
                    let body = dataTable.shadowRoot.querySelector('tbody');
                    keydown(body, 'ArrowDown');
                    assert.equal(dataTable._selectedIndex, 1);

                    done();
                });
            });
            linker.trigger();
        });

        // it('enter should select the table row', (done) => {
        //
        //     dataTable.addEventListener('data-loaded', () => {
        //         dataTable._collection.addEventListener('data-changed', () => {
        //             dataTable.focus();
        //             let body = dataTable.shadowRoot.querySelector('tbody');
        //             keydown(body, 'ArrowDown');
        //             keydown(dataTable, 'Enter');
        //             dataTable.addEventListener('tablerow-selected', (r) =>{
        //                 console.log(r);
        //                 done();
        //             });
        //
        //         });
        //     });
        //     linker.trigger();
        // });

        it('should have 3 entity items', (done) => {

            dataTable.addEventListener('data-loaded', () => {
                dataTable._collection.addEventListener('data-changed', () => {
                    dataTable.focus();
                    assert.equal(dataTable._collection.data.length, 3);

                    done();
                });

            });
            linker.trigger();
        });

        it('should render 3 table rows', (done) => {

            dataTable.addEventListener('data-loaded', () => {
                dataTable._collection.addEventListener('data-changed', () => {
                    dataTable.focus();

                    assert.equal(dataTable.shadowRoot.querySelector('table').querySelector('tbody').children.length, 10);
                    done();
                });

            });
            linker.trigger();
        });

    });
</script>
</body>
</html>
